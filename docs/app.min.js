const GRID_WIDTH=50,GRID_HEIGHT=60,DEFAULT_COLOR="#00FFD1",SHAPE_SIZES={module:{width:50,height:60},connector:{width:50,height:60},"connector-circle":{width:30,height:30},"connector-line":{width:50,height:50}},state={selectedType:"module",selectedColor:"#00FFD1",width:50,height:60,radius:5,opacity:100,padding:0,selectedElement:null,selectedElements:[],elements:[],groups:[],snapToGrid:!0,gridWidth:50,gridHeight:60,isMultiSelect:!1,connections:[],connectionMode:!1,firstElement:null,connectionThickness:5,connectionColor:"#00FFD1"};let DOM={};function initDOM(){DOM={canvas:document.getElementById("canvas"),canvasWrapper:document.querySelector(".canvas-wrapper"),snapGuide:document.getElementById("snapGuide"),alignGuideV:document.getElementById("alignGuideV"),alignGuideH:document.getElementById("alignGuideH"),distanceIndicator:document.getElementById("distanceIndicator"),connectionsLayer:document.getElementById("connectionsLayer"),sliders:{width:document.getElementById("widthSlider"),height:document.getElementById("heightSlider"),radius:document.getElementById("radiusSlider"),opacity:document.getElementById("opacitySlider"),padding:document.getElementById("paddingSlider"),connectionThickness:document.getElementById("connectionThicknessSlider")},values:{width:document.getElementById("widthValue"),height:document.getElementById("heightValue"),radius:document.getElementById("radiusValue"),opacity:document.getElementById("opacityValue"),padding:document.getElementById("paddingValue"),connectionThickness:document.getElementById("connectionThicknessValue")},elementCount:document.getElementById("elementCount"),gridBg:document.getElementById("gridBg"),connectionToggle:document.getElementById("connectionToggle"),deleteAllConnections:document.getElementById("deleteAllConnections"),modalOverlay:document.getElementById("modalOverlay"),modalTitle:document.getElementById("modalTitle"),modalBody:document.getElementById("modalBody"),modalFooter:document.getElementById("modalFooter"),modalClose:document.getElementById("modalClose"),modalCancel:document.getElementById("modalCancel"),modalConfirm:document.getElementById("modalConfirm")}}const Utils={getCanvasCoords(e,t){const n=DOM.canvas.getBoundingClientRect();return{x:Math.round(e-n.left),y:Math.round(t-n.top)}},snapToGridX:(e,t)=>50*Math.floor(e/50),snapToGridY:(e,t)=>60*Math.floor(e/60),roundToGridX:e=>50*Math.round(e/50),roundToGridY:e=>60*Math.round(e/60),gridPos:(e,t)=>({x:50*t,y:60*e}),updateValueDisplay(e,t,n="px"){e.textContent=t+n}},ModalManager={showAlert(e,t){return new Promise(n=>{DOM.modalTitle.textContent=e,DOM.modalBody.textContent=t,DOM.modalFooter.style.display="flex",DOM.modalCancel.style.display="none",DOM.modalConfirm.textContent="Aceptar",DOM.modalOverlay.classList.add("active");const o=()=>{this.closeModal(),n(!1)};DOM.modalConfirm.onclick=()=>{this.closeModal(),n(!0)},DOM.modalClose.onclick=o,DOM.modalOverlay.onclick=e=>{e.target===DOM.modalOverlay&&o()}})},showConfirm(e,t){return new Promise(n=>{DOM.modalTitle.textContent=e,DOM.modalBody.textContent=t,DOM.modalFooter.style.display="flex",DOM.modalCancel.style.display="block",DOM.modalConfirm.textContent="Confirmar",DOM.modalOverlay.classList.add("active");const o=()=>{this.closeModal(),n(!1)};DOM.modalConfirm.onclick=()=>{this.closeModal(),n(!0)},DOM.modalCancel.onclick=o,DOM.modalClose.onclick=o,DOM.modalOverlay.onclick=e=>{e.target===DOM.modalOverlay&&o()}})},showInfo(e,t){return new Promise(n=>{DOM.modalTitle.textContent=e,DOM.modalBody.innerHTML=t,DOM.modalFooter.style.display="none",DOM.modalOverlay.classList.add("active");const o=()=>{this.closeModal(),n(!0)};DOM.modalClose.onclick=o,DOM.modalOverlay.onclick=e=>{e.target===DOM.modalOverlay&&o()}})},closeModal(){DOM.modalOverlay.classList.remove("active"),DOM.modalConfirm.onclick=null,DOM.modalCancel.onclick=null,DOM.modalClose.onclick=null,DOM.modalOverlay.onclick=null}},PATTERNS={pattern1:[{row:0,col:0,type:"module"},{row:1,col:0,type:"module"}],pattern2:[{row:0,col:1,type:"module"},{row:1,col:0,type:"module"},{row:1,col:1,type:"connector"},{row:1,col:2,type:"module"}],pattern3:[{row:0,col:1,type:"module"},{row:1,col:0,type:"module"},{row:1,col:1,type:"connector"},{row:1,col:2,type:"module"},{row:2,col:1,type:"module"}],pattern4:[{row:0,col:1,type:"module"},{row:1,col:0,type:"module"},{row:1,col:2,type:"module"},{row:2,col:1,type:"module"}],pattern5:[{row:0,col:0,type:"module"},{row:1,col:1,type:"module"},{row:0,col:2,type:"module"}],pattern6:[{row:0,col:0,type:"module"},{row:1,col:1,type:"module"},{row:2,col:2,type:"module"}],pattern7:[{row:0,col:0,type:"module"},{row:1,col:1,type:"module"},{row:0,col:2,type:"module"}],pattern8:[{row:0,col:2,type:"module"},{row:1,col:1,type:"module"},{row:2,col:0,type:"module"}],pattern9:[{row:0,col:0,type:"module"},{row:0,col:1,type:"module"},{row:1,col:1,type:"module"},{row:1,col:2,type:"module"}],pattern10:[{row:0,col:1,type:"module"},{row:1,col:2,type:"module"},{row:2,col:1,type:"module"},{row:3,col:1,type:"connector-circle"}]},LOGOS={main:[{row:0,col:1,type:"module"},{row:1,col:0,type:"module"},{row:1,col:1,type:"connector"},{row:1,col:2,type:"module"},{row:2,col:1,type:"module"}],mascota:[{row:0,col:1,type:"module"},{row:1,col:0,type:"module"},{row:1,col:1,type:"connector"},{row:1,col:2,type:"module"},{row:2,col:1,type:"module"}],mini:[{row:0,col:1,type:"connector-circle"},{row:1,col:0,type:"connector-circle"},{row:1,col:1,type:"connector"},{row:1,col:2,type:"connector-circle"},{row:2,col:1,type:"connector-circle"}]},ShapeFactory={createStarPath(e,t,n){const o=.2*n;return`\n            M ${e},${t-n}\n            C ${e+o},${t-o} ${e+o},${t-o} ${e+n},${t}\n            C ${e+o},${t+o} ${e+o},${t+o} ${e},${t+n}\n            C ${e-o},${t+o} ${e-o},${t+o} ${e-n},${t}\n            C ${e-o},${t-o} ${e-o},${t-o} ${e},${t-n}\n            Z\n        `},createConnectorInner(e,t,n){const o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.setAttribute("viewBox","0 0 100 100"),o.style.cssText="position:absolute;top:0;left:0;pointer-events:none";const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",this.createStarPath(50,50,45)),s.setAttribute("fill",e),o.appendChild(s),o},getBorderRadius:(e,t)=>({"connector-circle":"50%","connector-line":t/2+"px",connector:"0px",module:`${state.radius}px`}[e]||`${state.radius}px`),createDeleteButton(e){const t=document.createElement("button");return t.className="delete-btn",t.innerHTML="×",t.addEventListener("click",t=>{t.stopPropagation(),ShapeFactory.deleteElement(e)}),t},createInfo(e,t){const n=document.createElement("div");return n.className="element-info",n.textContent=`${e}×${t}px`,n},deleteElement(e){ConnectionManager.deleteElementConnections(e),e.parentNode===DOM.canvas&&DOM.canvas.removeChild(e),state.elements=state.elements.filter(t=>t!==e),state.selectedElements=state.selectedElements.filter(t=>t!==e),updateElementCount(),state.selectedElement===e&&(state.selectedElement=null)}},PatternBuilder={build(e,t=200,n=200,o=!1){const s=[];return e.forEach(({row:e,col:o,type:a})=>{const l=Utils.gridPos(e,o),c=createElement(t+l.x,n+l.y,a);s.push(c)}),o&&s.length>1&&GroupManager.createGroup(s),s},createLogo(e,t,n){const o=LOGOS[e];return this.build(o,t,n,!1)}},AlignmentHelper={findNearbyElements(e){const t=1.5*Math.max(50,60),n=e.offsetLeft,o=e.offsetTop,s=n+parseInt(e.style.width)/2,a=o+parseInt(e.style.height)/2,l=[];return state.elements.forEach(n=>{if(n===e)return;const o=n.offsetLeft,c=n.offsetTop,i=o+parseInt(n.style.width)/2,d=c+parseInt(n.style.height)/2,r=Math.abs(s-i),m=Math.abs(a-d);(r<t||m<t)&&l.push({element:n,x:o,y:c,centerX:i,centerY:d,distX:r,distY:m})}),l},showGuides(e){const t=this.findNearbyElements(e),n=e.offsetLeft,o=e.offsetTop,s=n+parseInt(e.style.width)/2,a=o+parseInt(e.style.height)/2;let l=!1,c=!1,i=null,d=null;if(t.forEach(e=>{Math.abs(s-e.centerX)<25&&(l=!0,(!i||Math.abs(s-e.centerX)<Math.abs(s-i))&&(i=e.centerX)),Math.abs(a-e.centerY)<30&&(c=!0,(!d||Math.abs(a-e.centerY)<Math.abs(a-d))&&(d=e.centerY))}),l&&null!==i?(DOM.alignGuideV.style.left=i+"px",DOM.alignGuideV.classList.add("active")):DOM.alignGuideV.classList.remove("active"),c&&null!==d?(DOM.alignGuideH.style.top=d+"px",DOM.alignGuideH.classList.add("active")):DOM.alignGuideH.classList.remove("active"),t.length>0){const e=t.reduce((e,t)=>Math.min(e.distX,e.distY)<Math.min(t.distX,t.distY)?e:t),n=Math.min(e.distX,e.distY),o=55,l=Math.round(n/o*100)/100;DOM.distanceIndicator.textContent=`${l.toFixed(1)} grid`,DOM.distanceIndicator.style.left=s+20+"px",DOM.distanceIndicator.style.top=a-20+"px",DOM.distanceIndicator.classList.add("active")}else DOM.distanceIndicator.classList.remove("active")},hideGuides(){DOM.alignGuideV.classList.remove("active"),DOM.alignGuideH.classList.remove("active"),DOM.distanceIndicator.classList.remove("active")}},GroupManager={createGroup(e){const t=`group-${Date.now()}`,n={id:t,elements:e};return e.forEach(e=>{e.dataset.groupId=t,e.classList.add("grouped")}),state.groups.push(n),n},ungroup(e){const t=state.groups.find(t=>t.id===e);t&&(t.elements.forEach(e=>{delete e.dataset.groupId,e.classList.remove("grouped")}),state.groups=state.groups.filter(t=>t.id!==e))},getGroup:e=>state.groups.find(t=>t.id===e.dataset.groupId)},ConnectionManager={getElementCenter(e){const t=parseInt(e.style.left),n=parseInt(e.style.top);return{x:t+parseInt(e.style.width)/2,y:n+parseInt(e.style.height)/2}},getEdgePoint(e,t,n){const o=parseInt(e.style.left),s=parseInt(e.style.top),a=parseInt(e.style.width),l=parseInt(e.style.height),c=o+a/2,i=s+l/2,d=t-c,r=n-i;if(0===d&&0===r)return{x:c,y:i};Math.atan2(r,d);const m=a/2,u=l/2;let p,g;return Math.abs(r/d)<u/m?d>0?(p=c+m,g=i+m*r/d):(p=c-m,g=i-m*r/d):r>0?(p=c+u*d/r,g=i+u):(p=c-u*d/r,g=i-u),{x:p,y:g}},createConnection(e,t){const n=`conn-${Date.now()}`,o={id:n,from:e,to:t,color:state.connectionColor,thickness:state.connectionThickness,lineElement:null};return e.dataset.connections?e.dataset.connections+=","+n:e.dataset.connections=n,t.dataset.connections?t.dataset.connections+=","+n:t.dataset.connections=n,state.connections.push(o),this.renderConnection(o),o},renderConnection(e){const t=this.getElementCenter(e.from),n=this.getElementCenter(e.to),o=this.getEdgePoint(e.from,n.x,n.y),s=this.getEdgePoint(e.to,t.x,t.y),a=document.createElementNS("http://www.w3.org/2000/svg","g");a.dataset.connectionId=e.id,a.classList.add("connection-line");const l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",o.x),l.setAttribute("y1",o.y),l.setAttribute("x2",s.x),l.setAttribute("y2",s.y),l.setAttribute("stroke",e.color),l.setAttribute("stroke-width",e.thickness),l.setAttribute("stroke-linecap","round");const c=2.5*e.thickness,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d",ShapeFactory.createStarPath(o.x,o.y,c/2)),i.setAttribute("fill",e.color),i.classList.add("connection-star");const d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d",ShapeFactory.createStarPath(s.x,s.y,c/2)),d.setAttribute("fill",e.color),d.classList.add("connection-star"),a.appendChild(l),a.appendChild(i),a.appendChild(d),a.addEventListener("click",t=>{t.stopPropagation(),this.selectConnection(e)}),DOM.connectionsLayer.appendChild(a),e.lineElement=a,e.line=l,e.starFrom=i,e.starTo=d},updateConnection(e){if(!e.line)return;const t=this.getElementCenter(e.from),n=this.getElementCenter(e.to),o=this.getEdgePoint(e.from,n.x,n.y),s=this.getEdgePoint(e.to,t.x,t.y);e.line.setAttribute("x1",o.x),e.line.setAttribute("y1",o.y),e.line.setAttribute("x2",s.x),e.line.setAttribute("y2",s.y);const a=2.5*e.thickness;e.starFrom.setAttribute("d",ShapeFactory.createStarPath(o.x,o.y,a/2)),e.starTo.setAttribute("d",ShapeFactory.createStarPath(s.x,s.y,a/2))},updateAllConnections(){state.connections.forEach(e=>{this.updateConnection(e)})},deleteConnection(e){const t=state.connections.find(t=>t.id===e);t&&(t.lineElement&&t.lineElement.parentNode&&t.lineElement.parentNode.removeChild(t.lineElement),[t.from,t.to].forEach(t=>{if(t&&t.dataset.connections){const n=t.dataset.connections.split(",").filter(t=>t!==e);n.length>0?t.dataset.connections=n.join(","):delete t.dataset.connections}}),state.connections=state.connections.filter(t=>t.id!==e))},deleteElementConnections(e){if(!e.dataset.connections)return;e.dataset.connections.split(",").forEach(e=>this.deleteConnection(e))},deleteAllConnections(){[...state.connections].forEach(e=>{this.deleteConnection(e.id)})},selectConnection(e){state.connections.forEach(e=>{e.lineElement&&e.lineElement.classList.remove("selected")}),e.lineElement&&e.lineElement.classList.add("selected")},handleElementClick(e){return!!state.connectionMode&&(state.firstElement?(state.firstElement!==e&&this.createConnection(state.firstElement,e),state.firstElement.classList.remove("connection-pending"),state.firstElement=null,!0):(state.firstElement=e,e.classList.add("connection-pending"),!0))},toggleConnectionMode:()=>(state.connectionMode=!state.connectionMode,!state.connectionMode&&state.firstElement&&(state.firstElement.classList.remove("connection-pending"),state.firstElement=null),state.connectionMode)};function createElement(e,t,n=null){const o=n||state.selectedType,s=SHAPE_SIZES[o]||{width:50,height:60},a=s.width,l=s.height,c=document.createElement("div");c.className="element "+o;const i=Utils.snapToGridX(e,a),d=Utils.snapToGridY(t,l);return Object.assign(c.style,{left:`${i}px`,top:`${d}px`,width:`${a}px`,height:`${l}px`,opacity:state.opacity/100,background:"connector"===o?"transparent":state.selectedColor,borderRadius:ShapeFactory.getBorderRadius(o,l)}),"connector"===o?c.appendChild(ShapeFactory.createConnectorInner(state.selectedColor,a,l)):state.padding>0&&(c.style.boxShadow=`inset 0 0 0 ${state.padding}px #0A0F1A`),c.appendChild(ShapeFactory.createDeleteButton(c)),c.appendChild(ShapeFactory.createInfo(a,l)),c.addEventListener("click",e=>{e.stopPropagation(),ConnectionManager.handleElementClick(c)||(e.ctrlKey||e.metaKey?toggleElementSelection(c):selectElement(c))}),makeDraggable(c),DOM.canvas.appendChild(c),state.elements.push(c),updateElementCount(),c}function toggleElementSelection(e){const t=state.selectedElements.indexOf(e);t>-1?(state.selectedElements.splice(t,1),e.classList.remove("selected")):(state.selectedElements.push(e),e.classList.add("selected")),state.selectedElement=state.selectedElements[state.selectedElements.length-1]||null}function selectElement(e){state.selectedElement&&state.selectedElement.classList.remove("selected"),state.selectedElement=e,e.classList.add("selected");window.getComputedStyle(e);state.width=parseInt(e.style.width),state.height=parseInt(e.style.height),state.radius=parseInt(e.style.borderRadius)||0,state.opacity=Math.round(100*parseFloat(e.style.opacity));const t=e.style.boxShadow;if(t&&t.includes("inset")){const e=t.match(/inset 0 0 0 (\d+)px/);state.padding=e?parseInt(e[1]):0}else state.padding=0;if(e.classList.contains("connector")){const t=e.querySelector("svg path");t&&(state.selectedColor=t.getAttribute("fill"))}else state.selectedColor=e.style.background||"#00FFD1";DOM.sliders.width.value=state.width,DOM.sliders.height.value=state.height,DOM.sliders.radius.value=state.radius,DOM.sliders.opacity.value=state.opacity,DOM.sliders.padding.value=state.padding,DOM.values.width.textContent=state.width+"px",DOM.values.height.textContent=state.height+"px",DOM.values.radius.textContent=state.radius+"px",DOM.values.opacity.textContent=state.opacity+"%",DOM.values.padding.textContent=state.padding+"px"}function makeDraggable(e){let t,n,o=!1,s=new Map;e.addEventListener("mousedown",a=>{if(a.target.classList.contains("delete-btn"))return;o=!0,t=a.clientX,n=a.clientY;if(e.dataset.groupId){const t=GroupManager.getGroup(e);t&&t.elements.forEach(e=>{s.set(e,{x:e.offsetLeft,y:e.offsetTop}),e.style.cursor="grabbing"})}else s.set(e,{x:e.offsetLeft,y:e.offsetTop}),e.style.cursor="grabbing";a.preventDefault(),DOM.snapGuide.classList.add("active")}),document.addEventListener("mousemove",a=>{if(!o)return;const l=a.clientX-t,c=a.clientY-n;if(e.dataset.groupId){const t=GroupManager.getGroup(e);if(t){t.elements.forEach(e=>{const t=s.get(e),n=t.x+l,o=t.y+c,a=Utils.roundToGridX(n),i=Utils.roundToGridY(o);e.style.left=a+"px",e.style.top=i+"px"});const n=s.get(e).x+l,o=s.get(e).y+c,a=Utils.roundToGridX(n),i=Utils.roundToGridY(o);DOM.snapGuide.style.left=a+"px",DOM.snapGuide.style.top=i+"px"}}else{const t=s.get(e),n=t.x+l,o=t.y+c,a=Utils.roundToGridX(n),i=Utils.roundToGridY(o);e.style.left=a+"px",e.style.top=i+"px",DOM.snapGuide.style.left=a+"px",DOM.snapGuide.style.top=i+"px"}AlignmentHelper.showGuides(e)}),document.addEventListener("mouseup",()=>{o&&(o=!1,s.forEach((e,t)=>{t.style.cursor="move"}),s.clear(),DOM.snapGuide.classList.remove("active"),AlignmentHelper.hideGuides(),ConnectionManager.updateAllConnections())})}function updateElementCount(){DOM.elementCount.textContent=`Elementos: ${state.elements.length}`}function initEventHandlers(){document.querySelectorAll(".shape-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".shape-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),state.selectedType=this.dataset.type;const e=SHAPE_SIZES[this.dataset.type]||{width:50,height:60};state.width=e.width,state.height=e.height,DOM.sliders.width.value=e.width,DOM.sliders.height.value=e.height,DOM.values.width.textContent=e.width+"px",DOM.values.height.textContent=e.height+"px"})}),document.querySelectorAll(".color-option").forEach(e=>{e.addEventListener("click",function(){if(document.querySelectorAll(".color-option").forEach(e=>e.classList.remove("active")),this.classList.add("active"),state.selectedColor=this.dataset.color,state.selectedElement)if(state.selectedElement.classList.contains("connector")){const e=state.selectedElement.querySelector("svg path");e&&e.setAttribute("fill",state.selectedColor)}else state.selectedElement.style.background=state.selectedColor})}),DOM.sliders.width.addEventListener("input",e=>{state.width=e.target.value,DOM.values.width.textContent=e.target.value+"px",state.selectedElement&&(state.selectedElement.style.width=state.width+"px")}),DOM.sliders.height.addEventListener("input",e=>{state.height=e.target.value,DOM.values.height.textContent=e.target.value+"px",state.selectedElement&&(state.selectedElement.style.height=state.height+"px",state.selectedElement.classList.contains("connector-line")&&(state.selectedElement.style.borderRadius=state.height/2+"px"))}),DOM.sliders.radius.addEventListener("input",e=>{state.radius=e.target.value,DOM.values.radius.textContent=e.target.value+"px",state.selectedElement&&(state.selectedElement.style.borderRadius=state.radius+"px")}),DOM.sliders.opacity.addEventListener("input",e=>{state.opacity=e.target.value,DOM.values.opacity.textContent=e.target.value+"%",state.selectedElement&&(state.selectedElement.style.opacity=state.opacity/100)}),DOM.sliders.padding.addEventListener("input",e=>{if(state.padding=e.target.value,DOM.values.padding.textContent=e.target.value+"px",state.selectedElement){const t=parseInt(e.target.value);state.selectedElement.style.boxShadow=t>0?`inset 0 0 0 ${t}px #0A0F1A`:"none"}}),DOM.canvas.addEventListener("click",e=>{if(e.target===DOM.canvas){state.selectedElement&&(state.selectedElement.classList.remove("selected"),state.selectedElement=null),state.selectedElements.forEach(e=>e.classList.remove("selected")),state.selectedElements=[];const t=Utils.getCanvasCoords(e.clientX,e.clientY);createElement(t.x,t.y)}}),document.getElementById("groupSelected").addEventListener("click",async()=>{state.selectedElements.length<2?await ModalManager.showAlert("Agrupación","Selecciona al menos 2 elementos para agrupar (usa Ctrl/Cmd + Click)"):(GroupManager.createGroup(state.selectedElements),await ModalManager.showAlert("Agrupación Exitosa",`${state.selectedElements.length} elementos agrupados correctamente`))}),document.getElementById("ungroupSelected").addEventListener("click",async()=>{if(!state.selectedElement||!state.selectedElement.dataset.groupId)return void await ModalManager.showAlert("Desagrupación","Selecciona un elemento agrupado para desagrupar");const e=state.selectedElement.dataset.groupId;GroupManager.ungroup(e),await ModalManager.showAlert("Desagrupación Exitosa","El grupo ha sido desagrupado correctamente")}),document.getElementById("addElement").addEventListener("click",()=>{createElement(Math.random()*(DOM.canvas.offsetWidth-200)+100,Math.random()*(DOM.canvas.offsetHeight-200)+100)}),document.getElementById("clearCanvas").addEventListener("click",async()=>{if(0===state.elements.length&&0===state.connections.length)return void await ModalManager.showAlert("Canvas Vacío","El canvas ya está vacío");if(await ModalManager.showConfirm("Limpiar Canvas","¿Seguro que quieres eliminar todos los elementos y conexiones?")){ConnectionManager.deleteAllConnections();[...state.elements].forEach(e=>{e&&e.parentNode===DOM.canvas&&DOM.canvas.removeChild(e)}),state.elements=[],state.selectedElement=null,updateElementCount()}}),document.getElementById("exportSVG").addEventListener("click",()=>{let e=`<svg width="${DOM.canvas.offsetWidth}" height="${DOM.canvas.offsetHeight}" xmlns="http://www.w3.org/2000/svg">\n`;e+='  <rect width="100%" height="100%" fill="#0A0F1A"/>\n',state.connections.forEach(t=>{const n=ConnectionManager.getElementCenter(t.from),o=ConnectionManager.getElementCenter(t.to),s=ConnectionManager.getEdgePoint(t.from,o.x,o.y),a=ConnectionManager.getEdgePoint(t.to,n.x,n.y),l=2.5*t.thickness;e+=`  <line x1="${s.x}" y1="${s.y}" x2="${a.x}" y2="${a.y}" stroke="${t.color}" stroke-width="${t.thickness}" stroke-linecap="round"/>\n`,e+=`  <path d="${ShapeFactory.createStarPath(s.x,s.y,l/2)}" fill="${t.color}"/>\n`,e+=`  <path d="${ShapeFactory.createStarPath(a.x,a.y,l/2)}" fill="${t.color}"/>\n`}),state.elements.forEach(t=>{const n=parseInt(t.style.left),o=parseInt(t.style.top),s=parseInt(t.style.width),a=parseInt(t.style.height),l=t.style.opacity;if(t.classList.contains("connector")){const c=t.querySelector("svg path");if(c){const t=c.getAttribute("fill"),i=ShapeFactory.createStarPath(n+s/2,o+a/2,.45*Math.min(s,a));e+=`  <path d="${i}" fill="${t}" opacity="${l}"/>\n`}}else{const c=parseInt(t.style.borderRadius)||0,i=t.style.background;e+=`  <rect x="${n}" y="${o}" width="${s}" height="${a}" rx="${c}" fill="${i}" opacity="${l}"/>\n`}}),e+="</svg>";const t=new Blob([e],{type:"image/svg+xml"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download="crexative-design.svg",o.click()}),document.getElementById("gridToggle").addEventListener("click",function(){this.classList.toggle("active"),DOM.gridBg.style.display="none"===DOM.gridBg.style.display?"block":"none"}),document.getElementById("snapToggle").addEventListener("click",async function(){await ModalManager.showInfo("Snap a Grilla","El snap a la grilla está siempre activo para mantener la simetría perfecta de las moléculas y organismos.")}),DOM.connectionToggle.addEventListener("click",function(){const e=ConnectionManager.toggleConnectionMode();this.classList.toggle("active",e),e?(this.style.background="#00FFD1",this.style.color="#0A0F1A"):(this.style.background="",this.style.color="")}),DOM.sliders.connectionThickness.addEventListener("input",e=>{state.connectionThickness=parseInt(e.target.value),DOM.values.connectionThickness.textContent=e.target.value+"px"}),DOM.deleteAllConnections.addEventListener("click",async()=>{if(0===state.connections.length)return void await ModalManager.showAlert("Sin Conexiones","No hay conexiones para eliminar");await ModalManager.showConfirm("Eliminar Conexiones",`¿Seguro que quieres eliminar todas las ${state.connections.length} conexiones?`)&&(ConnectionManager.deleteAllConnections(),await ModalManager.showAlert("Conexiones Eliminadas","Todas las conexiones han sido eliminadas correctamente"))}),document.querySelectorAll(".section-title").forEach(e=>{e.addEventListener("click",function(){this.classList.toggle("collapsed");const e=this.nextElementSibling;e&&e.classList.contains("section-content")&&e.classList.toggle("collapsed")})}),document.addEventListener("keydown",e=>{"Delete"===e.key&&(state.selectedElements.length>0?(state.selectedElements.forEach(e=>{e.parentNode===DOM.canvas&&DOM.canvas.removeChild(e),state.elements=state.elements.filter(t=>t!==e)}),state.selectedElements=[],state.selectedElement=null,updateElementCount()):state.selectedElement&&ShapeFactory.deleteElement(state.selectedElement)),"Escape"===e.key&&(state.selectedElements.forEach(e=>e.classList.remove("selected")),state.selectedElements=[],state.selectedElement&&(state.selectedElement.classList.remove("selected"),state.selectedElement=null))}),document.addEventListener("click",e=>{e.target.closest(".element")||e.target.closest(".sidebar")||state.selectedElement&&(state.selectedElement.classList.remove("selected"),state.selectedElement=null)}),DOM.canvas.addEventListener("mousemove",e=>{const t=Utils.getCanvasCoords(e.clientX,e.clientY),n=50*Math.floor(t.x/50),o=60*Math.floor(t.y/60);DOM.snapGuide.style.transform="translate3d(0, 0, 0)",DOM.snapGuide.style.left=n+"px",DOM.snapGuide.style.top=o+"px",DOM.snapGuide.classList.add("active")}),DOM.canvas.addEventListener("mouseleave",()=>{DOM.snapGuide.classList.remove("active")})}document.addEventListener("DOMContentLoaded",()=>{initDOM(),initEventHandlers(),updateElementCount()});